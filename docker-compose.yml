version: "3.8"

services:
  n8n:
    image: n8nio/n8n:2.3.5
    container_name: n8n
    restart: always
    environment:
      N8N_HOST: n8n.exonas.net
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      NODE_ENV: production
      WEBHOOK_URL: https://n8n.exonas.net/
      GENERIC_TIMEZONE: Europe/Paris
      N8N_FILES_ALLOWED_PATHS: /home/node/.n8n-files
      N8N_BINARY_DATA_MODE: filesystem
    volumes:
      - n8n_data:/home/node/.n8n
      - n8n_files:/home/node/.n8n-files
    networks:
      - motorway2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.exonas.net`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.tls.certresolver=letsEncrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

  tdq-clipper:
    build:
      context: ./tdq-clipper
    image: tdq-clipper:latest
    container_name: tdq-clipper
    restart: always
    networks:
      - motorway2
    volumes:
      - tdq_files:/data
      - n8n_files:/n8n-files
      # Optionnel si un jour tu veux des cookies youtube:
      # - ./cookies.txt:/data/cookies.txt:ro
    expose:
      - "8580"

volumes:
  n8n_data:
  tdq_files:
  n8n_files:

networks:
  motorway2:
    external: true
